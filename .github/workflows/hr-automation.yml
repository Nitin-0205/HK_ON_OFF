name: HR Automation

on:
  # Auto-deploy on code changes
  push:
    branches: [ main, master ]
    paths:
      - 'mail_auto/Code.gs'
      - 'mail_auto/appsscript.json'
  
  # Scheduled runs (weekdays only)
  schedule:
    - cron: '0 9 * * 1-5'      # 9 AM UTC - send emails
    - cron: '0 11,13,15,17 * * 1-5'  # Every 2 hours - process replies
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      action:
        description: 'Action'
        type: choice
        options:
          - fullAutomation
          - sendEmails
          - processReplies
          - sendReminders
        default: 'fullAutomation'

jobs:
  deploy:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
    - run: npm install -g @google/clasp
    - run: |
        echo '${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}' > /tmp/creds.json
        clasp login --creds /tmp/creds.json --no-localhost
    - working-directory: mail_auto
      run: |
        echo '{"scriptId":"${{ secrets.SCRIPT_ID }}"}' > .clasp.json
        clasp push --force
    - if: always()
      run: rm -f /tmp/creds.json

  run:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
    - name: Set action
      id: action
      run: |
        if [ "${{ github.event_name }}" == "schedule" ]; then
          [ "$(date -u +%H)" == "09" ] && echo "action=sendEmails" >> $GITHUB_OUTPUT || echo "action=processReplies" >> $GITHUB_OUTPUT
        else
          echo "action=${{ github.event.inputs.action }}" >> $GITHUB_OUTPUT
        fi
    
    - name: Execute
      run: |
        ACTION="${{ steps.action.outputs.action }}"
        RESPONSE=$(curl -sL "${APPS_SCRIPT_WEB_APP_URL}?action=${ACTION}")
        echo "Action: $ACTION"
        echo "Response: $RESPONSE"
      env:
        APPS_SCRIPT_WEB_APP_URL: ${{ secrets.APPS_SCRIPT_WEB_APP_URL }}